# lightning.pytorch==2.1.1
seed_everything: 20250624
trainer:
  fast_dev_run: false
  num_sanity_val_steps: 0
  accelerator: auto
  strategy: auto
  devices: auto
  num_nodes: 1
  precision: 16-mixed
  logger:
    - class_path: lightning.pytorch.loggers.WandbLogger
      init_args:
        project: "arctic-sea-ice" 
        #name: "terramind-sic"
        save_dir: "output/wandb/sic"
        log_model: true
  callbacks:
    - class_path: src.utils.EpochShuffle
    - class_path: RichProgressBar
    - class_path: LearningRateMonitor
      init_args:
        logging_interval: epoch
    - class_path: src.utils.WandBConfigCallback
    - class_path: ModelCheckpoint
      init_args:
        monitor: val/Multiclass_Jaccard_Index
        mode: max
        filename: "best-jaccard-{epoch}"
        save_top_k: 1
    - class_path: ModelCheckpoint
      init_args:
        monitor: val/Multiclass_Accuracy
        mode: max
        filename: "best-mca-{epoch}"
        save_top_k: 1
    - class_path: EarlyStopping
      init_args:
        monitor: val/loss
        patience: 10 
        min_delta: 0.0005
        strict: false
        check_on_train_epoch_end: false
  max_epochs: 100
  log_every_n_steps: 5
  default_root_dir: output/ArcticSeaIce-SIC/

data:
  class_path: src.datasets.arctic_sea_ice.ArcticSeaIceDataModule
  init_args:
    batch_size: 10
    num_workers: 8
    data_root: /work/ka1176/caroline/gitlab/terramind-demo/data/arctic_sea_ice
    patch_size: 768
    target: SIC
    samples_per_chart: 20
    renormalize: true
    chart_weights: /work/ka1176/caroline/gitlab/terramind-demo/data/arctic_sea_ice/train/chart_weights.csv

model:
  class_path: terratorch.tasks.SemanticSegmentationTask
  init_args:
    model_factory: EncoderDecoderFactory
    model_args:
      backbone: terramind_v1_base  # large version: terramind_v1_large
      backbone_pretrained: true
      backbone_modalities:
        - S1GRD
      backbone_merge_method: mean

      necks:
        - name: SelectIndices
          indices: [2, 5, 8, 11]  # base version
#          indices: [5, 11, 17, 23]  # large version
        - name: ReshapeTokensToImage
          remove_cls_token: False
        - name: LearnedInterpolateToPyramidal

      decoder: UNetDecoder
      decoder_channels: [512, 256, 128, 64]

      head_dropout: 0.1
      num_classes: 11 
    loss: ce 
    ignore_index: -1
    class_weights: [0.0409, 4.61, 1.00, 1.18, 1.74, 1.09, 1.77, 0.945, 0.607, 0.327, 0.0906]
    plot_on_val: false
    freeze_backbone: false
    freeze_decoder: false
    tiled_inference_on_testing: true
    tiled_inference_parameters:
      h_crop: 512
      h_stride: 256
      w_crop: 512
      w_stride: 256
      average_patches: true
    class_names:
      - "SIC 0/10"
      - "SIC 1/10"
      - "SIC 2/10"
      - "SIC 3/10"
      - "SIC 4/10"
      - "SIC 5/10"
      - "SIC 6/10"
      - "SIC 7/10"
      - "SIC 8/10"
      - "SIC 9/10"
      - "SIC 10/10"

optimizer:
  class_path: torch.optim.AdamW
  init_args:
    lr: 2.0e-5
lr_scheduler:
  class_path: ReduceLROnPlateau
  init_args:
    monitor: val/loss
    factor: 0.5
    patience: 5
